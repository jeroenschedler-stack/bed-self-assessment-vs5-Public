<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BED Hospitality — Self-Assessment (SAR)</title>
  <meta name="theme-color" content="#1E90FF" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%231E90FF"/><text x="50%" y="56%" font-size="28" font-family="Arial,Helvetica,sans-serif" font-weight="700" text-anchor="middle" fill="white">BED</text></svg>'>

  <style>
    :root{
      --brand:#1E90FF;
      --border:#E5E7EB;
      --text:#111827;
      --sub:#374151;
      --active:#ff0000; /* new red for completed/current dots */
      --header-h:64px;
    }
    *{box-sizing:border-box}
    html,body{width:100%;height:auto;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,-apple-system,Arial,sans-serif;
      background:#F9FAFB;color:var(--text);
      padding-top: var(--header-h);
    }

    /* Header */
    .sar-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      height:var(--header-h);
      display:flex; align-items:center; justify-content:flex-start;
      padding:0 12px; background:#fff; border-bottom:1px solid var(--border);
      gap:12px;
    }
    @media (min-width:768px){ .sar-header{padding:0 16px} }

    .sar-logo-wrap{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; }
    .sar-logo{ font-size:28px; font-weight:800; letter-spacing:.35px; color:var(--text); white-space:nowrap; }
    .sar-dotbar{ display:flex; gap:10px; align-items:center; justify-content:flex-start }
    /* Dots 20% smaller (16px -> ~13px), no borders, new red for done/current */
    .sar-dot{ width:13px; height:13px; border-radius:50%; background:#E5E7EB; box-shadow:none; border:none; }
    .sar-dot.done{ background:var(--active); }
    .sar-dot.current{ background:var(--active); } /* current is also red */

    /* Global progress bar placed INSIDE header, shown only on q1/q2 */
    .global-progress{ width:100%; height:6px; /* 50% thicker than 4px */ 
      background:#E5E7EB; border-radius:3px; overflow:hidden; display:none; }
    .global-progress.show{ display:block; }
    .global-progress > span{ display:block; height:100%; width:0; background:var(--brand); transition:width .25s ease; }

    /* Layout */
    .sar-wrap{max-width:100%;width:100%;margin:0;padding:8px 12px 24px}
    @media (min-width:768px){ .sar-wrap{max-width:560px;margin:16px auto;padding:0 16px 24px} }

    /* Card */
    .sar-card{ background:#fff;border:1px solid var(--border);border-radius:12px;
      padding:20px 16px;box-shadow:0 1px 2px rgba(0,0,0,.04);min-height:auto }
    @media (max-width:430px){
      .sar-wrap{padding:0}
      .sar-card{border:none;box-shadow:none;border-radius:0;padding:16px}
      body{padding-bottom:env(safe-area-inset-bottom,16px)}
    }

    /* Titles */
    .sar-title{ font-size:22px; font-weight:800; }
.sar-para-title{font-size:14px;font-weight:800;text-transform:uppercase;color:#434343;margin-bottom:8px}
    .sar-sub{color:var(--sub);margin-bottom:16px}
.sar-intro p{ text-align: justify; }
p{color:#434343;line-height:1.6;}

    /* Rows & buttons */
    .sar-row{display:flex;gap:8px;flex-wrap:wrap}
    .sar-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.sar-page[data-step="peer"] .sar-actions{justify-content:flex-start}
.sar-page[data-step="peer"] .sar-actions .sar-btn{flex:0 0 calc((100% - 16px)/3);min-width:0}
    .sar-btn{
      display:inline-flex;align-items:center;justify-content:center;
      min-height:44px;min-width:140px;
      padding:10px 18px;border-radius:8px;border:1px solid #D1D5DB;
      background:#fff;color:var(--text);cursor:pointer;text-decoration:none;user-select:none;
      font-size:16px;font-weight:600;
    }
    .sar-btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .sar-btn:disabled{opacity:.6;cursor:not-allowed}

    /* Pages */
    .sar-page{display:none}
    .sar-page.active{display:block}

    /* Inputs */
    .sar-row-fields{gap:12px}
    .sar-field{flex:1;min-width:0;display:flex;flex-direction:column;gap:6px}
    .sar-label{font-size:12px;color:#6B7280}
    .sar-input{
      height:44px;padding:8px 10px;border:1px solid #D1D5DB;border-radius:8px;
      background:#fff;color:var(--text);outline:none;font-size:16px
    }
    .sar-input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(30,144,255,.15)}
    @media (max-width:420px){ .sar-row-fields{flex-direction:column} }

    /* Hotels one row */
    .sar-hotels{display:flex;gap:6px;flex-wrap:nowrap;justify-content:space-between}
    .sar-hotels .sar-hotel{flex:1 1 18%;min-width:0;text-transform:uppercase;font-weight:600;padding:10px 0;font-size:14px}
    .sar-hotel.selected{background:var(--brand);color:#fff;border-color:var(--brand)}

    /* Intro & scale (welcome) */
    .sar-intro p,.sar-scale{font-size:14px;line-height:1.45}
    @media (max-width:360px){ .sar-intro p,.sar-scale{font-size:13px} }
    .sar-scale-row{display:flex;align-items:center;gap:10px;margin:6px 0}
    .sar-badge{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:var(--brand);color:#fff;font-size:13px;font-weight:600}

    /* Extra space above start */
    .sar-page[data-step="welcome"] .sar-scale{margin-bottom:56px}

    /* Questions */
    .q-list{display:flex;flex-direction:column;gap:14px}
    .q-item{padding:12px 0;border-top:1px solid var(--border)}
    .q-item:first-child{border-top:none}
    .q-title{font-size:15px;font-weight:600;line-height:1.35;margin-bottom:2px}
    .q-sub{font-size:15px;line-height:1.35;color:var(--sub);margin-bottom:8px}
    .q-scale{display:flex;gap:8px}
    .q-scale input[type="radio"]{position:absolute;opacity:0;pointer-events:none}
    .q-scale label{
      width:36px;height:36px;border-radius:50%;
      border:1px solid #D1D5DB;background:#fff;color:#111827;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:14px;font-weight:600;cursor:pointer;user-select:none;
    }
    .q-scale input[type="radio"]:checked + label{
      background:var(--brand);border-color:var(--brand);color:#fff;
    }
  

/* Header stacked: brand → page title → dots */
:root{ --header-h: 100px; --header-gap: 8px; } 
.sar-logo-wrap{ display:flex; flex-direction:column; gap:var(--header-gap); }
.sar-page-title{ font-size:18px; font-weight:700; color:#434343; }
.sar-page .sar-title{ font-size:22px; font-weight:800; }
.sar-para-title{font-size:14px;font-weight:800;text-transform:uppercase;color:#434343;margin-bottom:8px}


/* SCORE page */
.score-wrap{display:flex;flex-direction:column;gap:16px;align-items:stretch;justify-content:flex-start}
.score-values{display:flex;flex-direction:column;align-items:flex-start;gap:6px;width:100%}
.score-label{font-size:14px;color:#434343;}
.score-label + .score-raw{margin-top:6px;}
.score-label + .score-band{margin-top:6px;}
.score-label + .score-band{margin-top:6px;}
.score-raw{ font-size: 28px; font-weight:800; color:#434343; }
.scorebar-wrap{ width:100%; margin:1.2em 0; }
.scorebar{ position:relative; width:100%; height:48px; 
  background: linear-gradient(90deg,#ef4444 0%, #f97316 20%, #facc15 40%, #a3e635 65%, #22c55e 100%);
  border-radius:8px; overflow:visible; border:1px solid #E5E7EB;
}
.score-marker{ position:absolute; top:50%; transform:translateY(-50%); 
  width:8px; height:68px; left:0; background:#434343; border-radius:8px;
}
.score-band{ font-size:22px; font-weight:700; color:#434343; text-align:left }

.global-progress{display:none!important}
    /* Finish page icon */
.finish-hero{ display:flex; justify-content:center; align-items:center; margin-top:8px; }
.finish-hero i{ font-size:72px; line-height:1; color:var(--brand); }

/* Spacers used in multiple pages */
.sar-gap-1{ height:1.2em; }
.sar-gap-3{ height:3.6em; }


/* Center the FINISH page content and size the icon relative to the text */
.sar-page[data-step="finish"] .sar-card{
  min-height: calc(100vh - var(--header-h) - 24px);
  display: flex;
  align-items: center;
  justify-content: center;
}
.finish-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  gap:16px;
}
.finish-hero svg{
  display:block;
  background-color:#1E90FF;
  border-radius:50%;
  padding:16px;
  box-sizing:border-box;
}
.finish-text{
  font-weight:700;
}

</style>
</head>
<body>

  <!-- Header -->
  <header class="sar-header">
    <div class="sar-logo-wrap">
      <div class="sar-logo">BED HOSPITALITY 2.0</div>
      <div class="sar-page-title" id="sarPageTitle" aria-live="polite"></div>
      <div class="sar-dotbar" id="dotbar" aria-label="Progress"></div>
      <!-- Global progress bar inside header -->
      <div class="global-progress" id="gprog" aria-hidden="true"><span id="gprogFill"></span></div>
    </div>
  </header>

  <main class="sar-wrap">
    <section class="sar-card">

      <!-- Welcome -->
      <div class="sar-page" data-step="welcome">
        <div style="max-width:75%">
          
        </div>

        <div class="sar-row sar-row-fields" style="margin-bottom:12px">
          <label class="sar-field">
            <span class="sar-label">your nickname</span>
            <input id="sarNick" type="text" class="sar-input" inputmode="text" autocomplete="nickname" />
          </label>
          <label class="sar-field">
            <span class="sar-label">your email</span>
            <input id="sarEmail" type="email" class="sar-input" inputmode="email" autocomplete="email" />
          </label>
        </div>

        <div class="sar-row sar-hotels" role="group" aria-label="Choose your BED Hotel" style="margin-bottom:12px">
                  <button class="sar-btn sar-hotel" data-hotel="BCK">BCK</button>
    <button class="sar-btn sar-hotel" data-hotel="BPS">BPS</button>
    <button class="sar-btn sar-hotel" data-hotel="BNM">BNM</button>
    <button class="sar-btn sar-hotel" data-hotel="BCG">BCG</button>
    <button class="sar-btn sar-hotel" data-hotel="FLY">FLY</button>
    <button class="sar-btn sar-hotel" data-hotel="BED">BED</button>
</div>

        <div class="sar-intro" style="margin-bottom:8px">
          <p>Self-assessment helps your personal growth and development. Read each statement and think how you act in these situations. Then select the rating that best fits you. Be honest with yourself. The goal is to know your own strengths and opportunities.</p>
        </div>

        <div class="sar-scale" style="margin-bottom:8px">
          <div class="sar-scale-row"><span class="sar-badge">1</span><span>I'm not good at this</span></div>
          <div class="sar-scale-row"><span class="sar-badge">2</span><span>I can do better in this</span></div>
          <div class="sar-scale-row"><span class="sar-badge">3</span><span>I'm good at this</span></div>
          <div class="sar-scale-row"><span class="sar-badge">4</span><span>I'm great at this</span></div>
          <div class="sar-scale-row"><span class="sar-badge">5</span><span>I'm excellent at this</span></div>
        </div>

            <div class="sar-gap-3"></div>
      <div class="sar-gap-3"></div>
  <div class="sar-actions">
          <button id="sarStart" class="sar-btn primary" data-nav="goto" data-step="q1" disabled>start</button>
        </div>
      </div>

      <!-- Part 1 — Dynamic questions -->
      <div class="sar-page" data-step="q1">
<!-- removed page-level thin progress bar (now in header) -->
        <div id="q1List" class="q-list" aria-live="polite"></div>
        
    <div class="sar-gap-3"></div>
<div class="sar-actions">
          <button class="sar-btn" data-nav="back">Back</button>
          <button id="q1Next" class="sar-btn primary" data-nav="goto" data-step="q2" disabled>Next</button>
        </div>
      </div>

      <!-- Part 2 — Dynamic questions -->
      <div class="sar-page" data-step="q2">
<!-- removed page-level thin progress bar (now in header) -->
        <div id="q2List" class="q-list" aria-live="polite"></div>
        
    <div class="sar-gap-3"></div>
<div class="sar-actions">
          <button class="sar-btn" data-nav="back">Back</button>
          <button id="q2Next" class="sar-btn primary" data-nav="next" disabled>Next</button>
        </div>
      </div>

      <!-- Placeholders -->
      <div class="sar-page" data-step="score">
  
  <div class="score-gap" aria-hidden="true"><br><br><br><br></div>
  <div class="score-wrap">
    <div class="score-values">
      <div class="score-label">your self assessment results</div>
      <div class="score-raw" id="scoreNumber">YOUR SCORE 0/100</div>
    </div>
    <div class="scorebar-wrap" aria-label="Score on color bar">
      <div class="scorebar" id="scoreBar">
        <span class="score-marker" id="scoreMarker" title="Your score"></span>
      </div>
    </div>
    <div class="score-label">our suggestion and recommendation</div>
    
    <div class="score-band" id="scoreBandText">—</div>
  </div>
  <div class="score-spacer"><br><br><br><br></div>
  <div class="sar-actions">
    <button class="sar-btn" data-nav="back">Back</button>
    <button class="sar-btn primary" data-nav="next">Next</button>
  </div>
</div>
      <div class="sar-page" data-step="peer">
  
    <div class="sar-gap-1"></div>
  <div class="sar-para-title">FIND YOUR PEER REVIEWER</div>
  <div class="sar-intro" style="margin-bottom:12px"><p>You completed your self-assessment report. The next step is your peer review. You can choose anyone in your team but he or she must have been in BED for min. 24 months. When your peer accepts to review you, complete the information below and press Send. This will forward the review form to your peer.</p></div>
  <div class="sar-gap-1"></div>
  <div class="sar-row sar-row-fields" style="margin-bottom:12px">
    <label class="sar-field">
      <span class="sar-label">peer nick name</span>
      <input id="peerName" type="text" class="sar-input" inputmode="text" />
    </label>
    <label class="sar-field">
      <span class="sar-label">peer email address</span>
      <input id="peerEmail" type="email" class="sar-input" inputmode="email" autocomplete="email" />
    </label>
  </div>
  <div class="sar-row sar-hotels" role="group" aria-label="Choose peer's BED Hotel" style="margin-bottom:12px">
    <button class="sar-btn sar-hotel" data-hotel="BCK">BCK</button>
    <button class="sar-btn sar-hotel" data-hotel="BPS">BPS</button>
    <button class="sar-btn sar-hotel" data-hotel="BNM">BNM</button>
    <button class="sar-btn sar-hotel" data-hotel="BCG">BCG</button>
    <button class="sar-btn sar-hotel" data-hotel="FLY">FLY</button>
    <button class="sar-btn sar-hotel" data-hotel="BED">BED</button>
  </div>
  <div class="sar-actions"><button class="sar-btn" data-nav="back">Back</button>
  <button id="peerSend" class="sar-btn" type="button">Send</button>
  
<label class="sar-check" style="display:flex;gap:8px;align-items:flex-start;line-height:1.3;margin:10px 0; font-size:14px; font-family:inherit;">
  <input id="peerConsent" type="checkbox" style="margin-top:3px;">
  <span>I agree to share my self-assessment with my peer</span>
</label>

</div>
</div>
      <div class="sar-page" data-step="done"><div class="sar-title">Done</div></div>
     <!-- FINISH PAGE -->
<div class="sar-page" data-step="finish">
  <div class="sar-card">
    <div class="finish-stack">
      <div class="finish-hero" aria-hidden="true">
        <svg id="finishIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
             style="width: 120px; height: 120px;">
          <circle cx="12" cy="12" r="12" fill="#1E90FF"/>
          <path d="M7 13L10 16L17 9"
                stroke="white"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"/>
        </svg>
      </div>
      <div id="finishText" class="sar-sub finish-text" style="font-size:24px;">Congratulations</div>
    </div>

    <!-- Three blank lines -->
    <div class="sar-gap-1"></div>
    <div class="sar-gap-1"></div>
    <div class="sar-gap-1"></div>

    <div class="sar-actions">
      <button class="sar-btn" data-nav="goto" data-step="peer">Back</button>
      <button class="sar-btn" id="finishPDF">PDF</button>
    </div>
  </div>
</div>
  </div>
</div>

    </section>
  </main>

  <script>
    const SAR_STEPS = ["welcome","q1","q2","score","peer","done","finish"];

    const sarState = {
      step: "welcome",
      user: { nickname: "", email: "", hotel: "" }, peer: { name: "", email: "", hotel: "" },
      answers: {},
      questions: []
    };

    function goTo(step){
      if(!SAR_STEPS.includes(step)) return;
      sarState.step = step;
      document.querySelectorAll('.sar-page').forEach(p=>{
        p.classList.toggle('active', p.dataset.step === step);
      });
      renderDots();
      updateHeaderTitle();
      updateGlobalProgress();
      if(step === "welcome") ensureWelcomeBindings();
      if(step === "q1") renderQ1();
      if(step === "q2") renderQ2();
      if(step === "score") renderScore();
      if(step === "peer") ensurePeerBindings();
      window.scrollTo({ top: 0, behavior: 'instant' });
    }
    function next(){
      const i = SAR_STEPS.indexOf(sarState.step);
      if(i < SAR_STEPS.length - 1) goTo(SAR_STEPS[i+1]);
    }
    function back(){
      const i = SAR_STEPS.indexOf(sarState.step);
      if(i > 0) goTo(SAR_STEPS[i-1]);
    }
    document.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-nav]');
      if(!btn) return;
      const act = btn.getAttribute('data-nav');
      if(act==='next') next();
      else if(act==='back') back();
      else if(act==='goto'){ const step = btn.getAttribute('data-step'); if(step) goTo(step); }
    });

    function renderDots(){
      const bar = document.getElementById('dotbar');
      bar.innerHTML = '';
      const currentIndex = SAR_STEPS.indexOf(sarState.step);
      SAR_STEPS.forEach((step, idx)=>{
        const d = document.createElement('div');
        let cls = 'sar-dot';
        if(idx <= currentIndex){ cls += ' done'; }
        if(idx === currentIndex){ cls += ' current'; }
        d.className = cls;
        bar.appendChild(d);
      });
    }

    let welcomeBound = false;
    function ensureWelcomeBindings(){
      if(welcomeBound){ validateWelcome(); return; }
      welcomeBound = true;
      const card = document.querySelector('.sar-page[data-step="welcome"]');
      const nick = card.querySelector('#sarNick');
      const email = card.querySelector('#sarEmail');
      const startBtn = card.querySelector('#sarStart');

      card.addEventListener('click',(e)=>{
        const btn = e.target.closest('.sar-hotel');
        if(!btn) return;
        card.querySelectorAll('.sar-hotel').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        sarState.user.hotel = btn.getAttribute('data-hotel') || "";
        validateWelcome();
      });
      nick.addEventListener('input', ()=>{ sarState.user.nickname = nick.value.trim(); validateWelcome(); });
      email.addEventListener('input', ()=>{ sarState.user.email = email.value.trim(); validateWelcome(); });
      startBtn.addEventListener('click',(e)=>{ if(startBtn.disabled){ e.preventDefault(); e.stopPropagation(); } });
      validateWelcome();
    }
    function validateWelcome(){
      const card = document.querySelector('.sar-page[data-step="welcome"]');
      if(!card) return;
      const nick = card.querySelector('#sarNick');
      const email = card.querySelector('#sarEmail');
      const startBtn = card.querySelector('#sarStart');
      const hasNick = (nick.value || "").trim().length > 0;
      const hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((email.value || "").trim());
      const hasHotel = !!sarState.user.hotel;
      startBtn.disabled = !(hasNick && hasEmail && hasHotel);
    }

    async function loadQuestions(){
      if (sarState.questions.length) return sarState.questions;
      const res = await fetch('./questions.json?v=1', {cache: 'no-store'});
      const data = await res.json();
      sarState.questions = Array.isArray(data) ? data : [];
      return sarState.questions;
    }

    async function renderQ1(){
      const qs = await loadQuestions();
      const slice = qs.slice(0, 16);
      const mount = document.getElementById('q1List');
      mount.innerHTML = slice.map(q => renderQuestionHTML(q)).join('');
      slice.forEach(q => {
        const v = sarState.answers[q.id];
        if(v){ const el = document.getElementById(`${q.id}_${v}`); if (el) el.checked = true; }
      });
      mount.onchange = onRatingChanged;
      updateGlobalProgress();
      validateQ1Completed(slice);
    }

    async function renderQ2(){
      const qs = await loadQuestions();
      const slice = qs.slice(16, 32);
      const mount = document.getElementById('q2List');
      mount.innerHTML = slice.map(q => renderQuestionHTML(q)).join('');
      slice.forEach(q => {
        const v = sarState.answers[q.id];
        if(v){ const el = document.getElementById(`${q.id}_${v}`); if (el) el.checked = true; }
      });
      mount.onchange = onRatingChanged;
      updateGlobalProgress();
      validateQ2Completed(slice);
    }

    function renderQuestionHTML(q){
      const name = `rate_${q.id}`;
      let radios = '';
      for(let v=1; v<=5; v++){
        const id = `${q.id}_${v}`;
        radios += `
          <input type="radio" name="${name}" id="${id}" value="${v}" />
          <label for="${id}" aria-label="${q.id} rate ${v}">${v}</label>
        `;
      }
      return `
        <div class="q-item" data-qid="${q.id}">
          <div class="q-title">${escapeHTML(q.statement)}</div>
          <div class="q-sub">${escapeHTML(q.subtext)}</div>
          <div class="q-scale">${radios}</div>
        </div>
      `;
    }

    // one handler for both pages
    function onRatingChanged(e){
      const input = e.target.closest('input[type="radio"]'); if(!input) return;
      const wrap = input.closest('.q-item'); const qid = wrap?.getAttribute('data-qid');
      const val = parseInt(input.value, 10);
      if(qid && val>=1 && val<=5){
        sarState.answers[qid] = val;
        updateGlobalProgress();
        if(sarState.step === 'q1'){
          const list = Array.from(document.querySelectorAll('#q1List .q-item'));
          validateQ1Completed(list);
        } else if(sarState.step === 'q2'){
          const list = Array.from(document.querySelectorAll('#q2List .q-item'));
          validateQ2Completed(list);
        }
      }
    }

    function validateQ1Completed(list){
      const items = Array.from(list);
      const allAnswered = items.every(el => sarState.answers[el.getAttribute('data-qid')]);
      document.getElementById('q1Next').disabled = !allAnswered;
    }
    function validateQ2Completed(list){
      const items = Array.from(list);
      const allAnswered = items.every(el => sarState.answers[el.getAttribute('data-qid')]);
      document.getElementById('q2Next').disabled = !allAnswered;
    }

    // Global progress across all 20 questions; visible only on q1/q2
    function updateGlobalProgress(){
      const bar = document.getElementById('gprog');
      const fill = document.getElementById('gprogFill');
      const show = (sarState.step === 'q1' || sarState.step === 'q2');
      bar.classList.toggle('show', show);
      if(!show) return;
      const total = (sarState.questions && sarState.questions.length) ? sarState.questions.length : 20;
      const answered = Object.keys(sarState.answers).length;
      const pct = total ? Math.round((answered/total)*100) : 0;
      fill.style.width = pct + '%';
    }

    // Correct escapeHTML
    function escapeHTML(s){
      return String(s).replace(/[&<>\"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
      });
    }

    goTo(sarState.step);
  
function scoreBand(pct){
  if (pct >= 80) return "Excellent! Inspire others.<br>Lead by example";
  if (pct >= 60) return "Great hospitality!<br>Keep challenging yourself";
  if (pct >= 40) return "Use self-development.<br>Practise makes you better";
  return "You’re behind.<br>Ask your team for guidance";
}
function renderScore(){
  const page = document.querySelector('.sar-page[data-step="score"]');
  if(!page) return;
  const qs = sarState.questions || [];
  const total = qs.length * 5;
  let sum = 0;
  qs.forEach(q => { sum += (sarState.answers[q.id] || 0); });
  const pct = total ? Math.round((sum / total) * 100) : 0;
  const rawEl = page.querySelector('#scoreNumber');
  const bandEl = page.querySelector('#scoreBandText');
  if(rawEl) rawEl.textContent = "YOUR SCORE " + (sum + "/" + total);
  if(bandEl) bandEl.innerHTML = scoreBand(pct);
  const marker = page.querySelector('#scoreMarker');
  if(marker){
    const clamped = Math.max(0, Math.min(100, pct));
    marker.style.left = `calc(${clamped}% - 4px)`;
  }
}
let peerBound = false;
function ensurePeerBindings(){
  if(peerBound){ validatePeer(); return; }
  peerBound = true;
  const card = document.querySelector('.sar-page[data-step="peer"]');
  if(!card) return;
  const nameEl = card.querySelector('#peerName');
  const emailEl = card.querySelector('#peerEmail');
  const nextBtn = card.querySelector('#peerNext');
  if(nextBtn){
    nextBtn.addEventListener('click', function(e){
      if(nextBtn.disabled){ e.preventDefault(); return; }
    });
  }

  if(nextBtn){
    nextBtn.addEventListener('click', function(e){
      if(nextBtn.disabled){ e.preventDefault(); return; }
      var hasName = (nameEl && nameEl.value || "").trim().length > 0;
      var hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((emailEl && emailEl.value || "").trim());
      var hasHotel = !!(sarState.peer && sarState.peer.hotel);
      if(!(hasName && hasEmail && hasHotel)){
        e.preventDefault();
        alert('Please fill peer nick name, email address, and select a hotel.');
        return;
      }
      if(!(sarState.peer && sarState.peer.confirm24)){
        var ok = confirm('your peer has 24 months experience?');
        if(!ok){
          e.preventDefault();
          alert('Please confirm YES to continue.');
          return;
        }
        sarState.peer = sarState.peer || {};
        sarState.peer.confirm24 = true;
        validatePeer();
        goTo('finish');
      }
    });
  }
  const shareBtn = card.querySelector('#peerShare');
card.addEventListener('click',(e)=>{
    const btn = e.target.closest('.sar-hotel');
    if(!btn) return;
    card.querySelectorAll('.sar-hotel').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    sarState.peer = sarState.peer || {name:'',email:'',hotel:''};
    sarState.peer.hotel = btn.getAttribute('data-hotel') || "";
    validatePeer();
  });
  if(nameEl) nameEl.addEventListener('input', ()=>{ sarState.peer = sarState.peer || {}; sarState.peer.name = nameEl.value.trim(); validatePeer(); });
  if(emailEl) emailEl.addEventListener('input', ()=>{ sarState.peer = sarState.peer || {}; sarState.peer.email = emailEl.value.trim(); validatePeer(); });
  if(shareBtn){ shareBtn.addEventListener('click',(e)=>{ e.preventDefault(); downloadSarResults(); }); }
      validatePeer();
  if(sendBtn){
    sendBtn.addEventListener('click', function(e){
      e.preventDefault();
      var hasName = (nameEl && nameEl.value || "").trim().length > 0;
      var hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((emailEl && emailEl.value || "").trim());
      var hasHotel = !!(sarState.peer && sarState.peer.hotel);
      if(!(hasName && hasEmail && hasHotel)){
        alert('Please fill peer nick name, email address, and select a hotel.');
        return;
      }
      var ok = confirm('your peer has 24 months experience?');
      if(!ok){
        alert('Please confirm YES to continue.');
        return;
      }
      sarState.peer = sarState.peer || {};
      sarState.peer.confirm24 = true;
      validatePeer();
    });
  }
  validatePeer();
  if(sendBtn){
    sendBtn.addEventListener('click', function(e){
      e.preventDefault();
      var hasName = (nameEl && nameEl.value || "").trim().length > 0;
      var hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((emailEl && emailEl.value || "").trim());
      var hasHotel = !!(sarState.peer && sarState.peer.hotel);
      if(!(hasName && hasEmail && hasHotel)){
        alert('Please fill peer nick name, email address, and select a hotel.');
        return;
      }
      var ok = confirm('your peer has 24 months experience?');
      if(!ok){
        alert('Please confirm YES to continue.');
        return;
      }
      sarState.peer = sarState.peer || {};
      sarState.peer.confirm24 = true;
      validatePeer();
    });
  }
  validatePeer();
}
function validatePeer(){
  const card = document.querySelector('.sar-page[data-step="peer"]');
  if(!card) return;
  const nameEl = card.querySelector('#peerName');
  const emailEl = card.querySelector('#peerEmail');
  const nextBtn = card.querySelector('#peerNext');

  if(nextBtn){
    nextBtn.addEventListener('click', function(e){
      if(nextBtn.disabled){ e.preventDefault(); return; }
      var hasName = (nameEl && nameEl.value || "").trim().length > 0;
      var hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((emailEl && emailEl.value || "").trim());
      var hasHotel = !!(sarState.peer && sarState.peer.hotel);
      if(!(hasName && hasEmail && hasHotel)){
        e.preventDefault();
        alert('Please fill peer nick name, email address, and select a hotel.');
        return;
      }
      if(!(sarState.peer && sarState.peer.confirm24)){
        var ok = confirm('your peer has 24 months experience?');
        if(!ok){
          e.preventDefault();
          alert('Please confirm YES to continue.');
          return;
        }
        sarState.peer = sarState.peer || {};
        sarState.peer.confirm24 = true;
        validatePeer();
        goTo('finish');
      }
    });
  }
  const hasName = (nameEl?.value || "").trim().length > 0;
  const hasEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((emailEl?.value || "").trim());
  const hasHotel = !!(sarState.peer && sarState.peer.hotel);
  if(nextBtn) nextBtn.disabled = !(hasName && hasEmail && hasHotel);
}
function updateHeaderTitle(){
  const slot = document.getElementById('sarPageTitle');
  if(!slot) return;
  const activeTitle = document.querySelector('.sar-page.active .sar-title');
  let text = '';
  if(activeTitle){ text = activeTitle.textContent.trim(); }
  const step = sarState.step;
  if(!text){
    const map = {welcome:'SELF-ASSESSMENT REPORT (SAR)', q1:'STATEMENTS PART 1', q2:'STATEMENTS PART 2', score:'SELF-ASSESSMENT SCORE', peer:'PEER ASSESSMENT', done:'YOU\'RE DONE', finish:'SELF- ASSESSMENT COMPLETED'
};
    text = map[step] || '';
  }
  slot.textContent = text;
}
function downloadSarResults(){
  const qs = sarState.questions || [];
  const rows = [];
  rows.push(['Nickname', sarState.user?.nickname || '']);
  rows.push(['Email', sarState.user?.email || '']);
  rows.push(['Hotel', sarState.user?.hotel || '']);
  rows.push(['Peer Name', sarState.peer?.name || '']);
  rows.push(['Peer Email', sarState.peer?.email || '']);
  rows.push(['Peer Hotel', sarState.peer?.hotel || '']);
  rows.push([]);
  rows.push(['Question ID','Statement','Your Rating']);
  let sum = 0, total = qs.length * 5;
  qs.forEach(q => { const v = sarState.answers[q.id] || 0; sum += v; rows.push([q.id, q.statement, v]); });
  rows.push([]);
  rows.push(['Total Score', sum + '/' + total]);
  const csv = rows.map(r => r.map(x => ('"'+String(x).replace(/"/g,'""')+'"')).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `BED-SAR-Results-${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}

</script>

<!-- Custom 24-month confirmation (no browser header) -->
<style>
  .exp24__mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:2147483646;}
  .exp24__modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.25);min-width:260px;max-width:92vw;display:none;z-index:2147483647;font-family:inherit}
  .exp24__hd{padding:14px 16px;border-bottom:1px solid #eee;font-weight:600}
  .exp24__bd{padding:16px 16px 8px 16px;font-size:15px;line-height:1.35}
  .exp24__ft{padding:12px 16px 16px 16px;display:flex;gap:10px;justify-content:flex-end}
  .exp24__btn{border:none;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
  .exp24__btn--ghost{background:#f2f4f7}
  .exp24__btn--primary{background:#1E90FF;color:#fff}
</style>
<div id="exp24Mask" class="exp24__mask"></div>
<div id="exp24Modal" class="exp24__modal" role="dialog" aria-modal="true" aria-labelledby="exp24Title">
  <div class="exp24__hd" id="exp24Title">Peer eligibility</div>
  <div class="exp24__bd">Does your peer have at least 24 months of BED experience?</div>
  <div class="exp24__ft">
    <button id="exp24Cancel" class="exp24__btn exp24__btn--ghost" type="button">Cancel</button>
    <button id="exp24OK" class="exp24__btn exp24__btn--primary" type="button">OK</button>
  </div>
</div>
<script>
(function(){
  function qs(id){ return document.getElementById(id); }
  const mask=qs('exp24Mask'), modal=qs('exp24Modal'), ok=qs('exp24OK'), no=qs('exp24Cancel');
  function openM(){ if(mask) mask.style.display='block'; if(modal) modal.style.display='block'; }
  function closeM(){ if(mask) mask.style.display='none'; if(modal) modal.style.display='none'; }

  // Attach only to Peer Done button, without changing existing code.
  function bind(){
    const next = document.getElementById('peerNext') || document.getElementById('peerSend');
    if(!next) return;
    if(next.dataset.exp24Bound==='1') return;
    next.dataset.exp24Bound='1';

    let bypass=false;
    next.addEventListener('click', function(e){
      if(bypass){ bypass=false; return; }
      e.preventDefault(); e.stopImmediatePropagation();
      openM();
      // On OK -> proceed exactly as the original click would
      
ok.onclick = function(){
  closeM();
  // Temporarily bypass any native confirm() the original handler shows
  var __origConfirm = window.confirm;
  window.__exp24Bypass = true;
  window.confirm = function(msg){
    if (window.__exp24Bypass) return true;
    return __origConfirm.call(window, msg);
  };
  // Trigger the original click so navigation proceeds
  bypass = true;
  next && next.click();
        try{ if(typeof goTo==='function'){ goTo('finish'); } }catch(_){ var target=document.querySelector('.sar-actions [data-nav="finish"]'); if(target) { target.removeAttribute('data-nav'); target.click(); } }
  // Restore confirm after a short delay
  setTimeout(function(){
    window.__exp24Bypass = false;
    window.confirm = __origConfirm;
  }, 600);
};

      // On Cancel -> stay
      no.onclick = closeM;
      mask && (mask.onclick = closeM);
    }, true); // capture so we intercept before app navigation
  }

  // initial + on step changes
  bind();
  window.addEventListener('hashchange', bind, {passive:true});
  document.addEventListener('click', function(){ setTimeout(bind,0); }, {passive:true});
})();
</script>


<!-- Peer consent validation -->
<script>
(function(){
  const peerNextButton = document.getElementById('peerNext');
  const peerNameInput = document.getElementById('peerName');
  const peerEmailInput = document.getElementById('peerEmail');
  const peerConsent = document.getElementById('peerConsent');

  function emailOK(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }

  function validatePeerConsent(){
    const nameOk = !!(peerNameInput && peerNameInput.value.trim());
    const emailOk = !!(peerEmailInput && emailOK(peerEmailInput.value));
    const consentOk = !!(peerConsent && peerConsent.checked);
    if (peerNextButton) peerNextButton.disabled = !(nameOk && emailOk && consentOk);
  }

  peerNameInput && peerNameInput.addEventListener('input', validatePeerConsent);
  peerEmailInput && peerEmailInput.addEventListener('input', validatePeerConsent);
  peerConsent && peerConsent.addEventListener('change', validatePeerConsent);

  // initialize state
  validatePeerConsent();
})();
</script>





<!-- Peer Consent Checkbox (isolated, positioned under hotels) -->
<script>
(function(){
  function injectPeerConsent(){
    var next = document.getElementById('peerNext');
    if(!next) return;
    if(document.getElementById('peerConsent')) return;

    // Find hotel buttons container
    var hotelRow = document.querySelector('.sar-row.sar-hotels') || next.closest('.sar-page').querySelector('.sar-hotels');
    if(!hotelRow) return;

    // Build the checkbox block
    var wrap = document.createElement('div');
    wrap.style.margin = '10px 0 16px';
    wrap.innerHTML = '<label class="sar-check" style="display:flex;gap:8px;align-items:flex-start;line-height:1.3; font-size:14px; font-family:inherit;">'
                   + '  <input id="peerConsent" type="checkbox" style="margin-top:3px;">'
                   + '  <span>I agree to share my self-assessment with my peer reviewer</span>'
                   + '</label>';
    var label = wrap.firstChild;

    // Insert directly after hotel buttons
    if(hotelRow && hotelRow.parentNode){
      hotelRow.parentNode.insertBefore(label, hotelRow.nextSibling);
    }

    // Hook validation so Done is enabled only when consent given
    var peerNameInput  = document.getElementById('peerName');
    var peerEmailInput = document.getElementById('peerEmail');
    var peerConsent    = document.getElementById('peerConsent');

    function emailOK(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }
    function validatePeerConsent(){
      var nameOk    = !!(peerNameInput && (peerNameInput.value||'').trim());
      var emailOk   = !!(peerEmailInput && emailOK(peerEmailInput.value));
      var consentOk = !!(peerConsent && peerConsent.checked);
      if (next) next.disabled = !(nameOk && emailOk && consentOk);
    }

    peerNameInput && peerNameInput.addEventListener('input', validatePeerConsent);
    peerEmailInput && peerEmailInput.addEventListener('input', validatePeerConsent);
    peerConsent && peerConsent.addEventListener('change', validatePeerConsent);
    validatePeerConsent();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', injectPeerConsent, {once:true});
  }else{
    injectPeerConsent();
  }
  window.addEventListener('hashchange', function(){ setTimeout(injectPeerConsent, 0); }, {passive:true});
})();
</script>


<!-- Peer Consent Adjustments: rename Send->Done, require consent, and chain to Next -->
<script>
(function(){
  function run(){
    var next = document.getElementById('peerNext');
    var send = document.getElementById('peerSend');
    if(!next && !send) return;

    // Rename "Send" to "Done" (text only)
    if(send && send.textContent && send.textContent.trim().toLowerCase() === 'send'){
      send.textContent = 'Done';
    }

    // Ensure consent checkbox sits above actions
    var consent = document.getElementById('peerConsent');
    var actions = (next && next.closest('.sar-actions')) || (send && send.closest('.sar-actions')) || (next||send).parentElement;
    if(consent && actions && actions.parentNode){
      var label = consent.closest('label');
      if(label && actions.previousElementSibling !== label){
        actions.parentNode.insertBefore(label, actions);
      }
    }

    // Validation: enable action only when name/email/consent valid
    var nameEl  = document.getElementById('peerName');
    var emailEl = document.getElementById('peerEmail');
    function emailOK(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }
    function validate(){
      var ok = !!(nameEl && (nameEl.value||'').trim()) &&
               !!(emailEl && emailOK(emailEl.value)) &&
               !!(document.getElementById('peerConsent') && document.getElementById('peerConsent').checked);
      var target = send || next;
      if(target) target.disabled = !ok;
    
    // Sync visual style: blue when enabled (uses existing .sar-btn.primary)
    if (target) {
      if (target.disabled) {
        target.classList.remove('primary');
      } else {
        target.classList.add('primary');
      }
    }
    } else {
        target.classList.add('sar-btn-active');
      }
    }
    }
    nameEl && nameEl.addEventListener('input', validate);
    emailEl && emailEl.addEventListener('input', validate);
    if(consent) consent.addEventListener('change', validate);
    validate();

    // Clicking the action button should also trigger Next (for 24-month confirm + navigation)
    var actionBtn = send || next;
    if(actionBtn && !actionBtn.dataset.chainBound){
      actionBtn.dataset.chainBound = '1';
      actionBtn.addEventListener('click', function(){
        if(actionBtn.disabled) return;
        if(next && actionBtn !== next){ setTimeout(function(){ next && next.click();
        try{ if(typeof goTo==='function'){ goTo('finish'); } }catch(_){ var target=document.querySelector('.sar-actions [data-nav="finish"]'); if(target) { target.removeAttribute('data-nav'); target.click(); } } }, 0); }
      });
    }
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', run, {once:true}); }
  else { run(); }
  window.addEventListener('hashchange', function(){ setTimeout(run,0); }, {passive:true});
})();
</script>


<!-- Peer page tidy-up: place consent under hotels, rename Send->Done, enable when valid -->
<script>
(function(){
  function emailOK(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }

  function runPeerFix(){
    var page = document.querySelector('.sar-page[data-step="peer"]') || document.querySelector('[data-step="peer"]');
    if(!page) return;

    var nameEl  = document.getElementById('peerName');
    var emailEl = document.getElementById('peerEmail');
    var consent = document.getElementById('peerConsent');
    var nextBtn = document.getElementById('peerNext');
    var sendBtn = document.getElementById('peerSend');
    var action  = sendBtn || nextBtn;
    if(!action) return;

    // 1) Move consent just above actions row (i.e., under hotels)
    if(consent){
      var label = consent.closest('label');
      var actions = action.closest('.sar-actions') || action.parentElement;
      if(label && actions && label.nextSibling !== actions){
        actions.parentNode.insertBefore(label, actions);
      }
    }

    // 2) Rename Send -> Done (visual text only)
    if(sendBtn && /send/i.test(sendBtn.textContent.trim())){
      sendBtn.textContent = 'Done';
    }

    // 3) Validate -> enable/disable + visual state (blue when enabled)
    function validate(){
      var ok = !!(nameEl && (nameEl.value||'').trim())
            && !!(emailEl && emailOK(emailEl.value))
            && !!(consent && consent.checked);
      action.disabled = !ok;
      // Use your existing primary style for blue buttons
      if(action.classList){
        if(action.disabled){ action.classList.remove('primary'); }
        else { action.classList.add('primary'); }
      }
    }
    nameEl  && nameEl.addEventListener('input', validate);
    emailEl && emailEl.addEventListener('input', validate);
    consent && consent.addEventListener('change', validate);
    validate();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', runPeerFix, {once:true});
  } else { runPeerFix(); }
  window.addEventListener('hashchange', function(){ setTimeout(runPeerFix, 0); }, {passive:true});
})();
</script>


<!-- Use checkmark.png on the completion page (non-destructive) -->
<style>
  .completion-check {
  width: 144px;
  height: 144px;
  border-radius: 50%;
  display: block;
  margin: 0 auto 16px auto;
  object-fit: contain;
}
</style>
<script>
(function(){
  function placeCheckImage(){
    var page = document.querySelector('.sar-page[data-step="finish"]') || document.querySelector('[data-step="finish"]');
    if(!page) return;
    if(page.querySelector('img.completion-check')) return; // already placed

    var img = document.createElement('img');
    img.src = 'checkmark.png';
    img.alt = 'Completed';
    img.className = 'completion-check';

    // Insert at the top of the finish page content
    if(page.firstElementChild){
      page.insertBefore(img, page.firstElementChild);
    } else {
      page.appendChild(img);
    }

    // If an existing SVG checkmark is present, hide it to avoid duplicates
    var oldSvg = page.querySelector('svg');
    if(oldSvg) oldSvg.style.display = 'none';
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', placeCheckImage, {once:true});
  } else {
    placeCheckImage();
  }
  // Also handle navigation to the finish step
  window.addEventListener('hashchange', function(){ setTimeout(placeCheckImage, 0); }, {passive:true});
})();
</script>


<script>
(function(){
  function sizeFinishIcon(){
    try{
      var txt = document.getElementById('finishText');
      var ico = document.getElementById('finishIcon');
      if(!txt || !ico) return;
      // Measure the rendered width of the "Congratulations" text
      var w = Math.max(48, Math.round(txt.getBoundingClientRect().width));
      // Apply as both width and height on the SVG
      ico.style.width  = w + 'px';
      ico.style.height = w + 'px';
    }catch(e){/* noop */}
  }

  // Hook into navigation changes
  var _goTo = window.goTo;
  window.goTo = function(step){
    if(typeof _goTo === 'function'){ _goTo(step); }
    if(step === 'finish'){
      // Ensure sizing after layout
      setTimeout(sizeFinishIcon, 0);
    }
  };

  // Also size on first load (in case finish is the first rendered) and on resize
  window.addEventListener('load', sizeFinishIcon, {once:true});
  window.addEventListener('resize', sizeFinishIcon, {passive:true});
})();
</script>

</body>
</html>
